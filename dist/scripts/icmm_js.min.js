angular.module("de.cismet.cids.rest.collidngNames.Nodes",["ngResource"]).factory("de.cismet.collidingNameService.Nodes",["$resource","$timeout","CRISMA_ICMM_API","CRISMA_DOMAIN",function(a,b,c,d){"use strict";var e,f,g,h;return f=function(a){var c,d,e,f=function(a){e=this,b(function(){g.children({filter:"parentworldstate.id:"+g.utils.getRequestIdForNodeKey(e.key)},a)},1e3)};if(!a)return null;c=a.childworldstates&&a.childworldstates.length>0?!0:!1;for(var h=a.parentworldstate,i=[a.id];h&&h.parentworldstate;)i.push(h.id),h=h.parentworldstate;return h&&i.push(h.id),d={key:i.reverse().join("."),name:a.name,classKey:42,objectKey:a.$self,type:"objectNode",org:"",dynamicChildren:"",clientSort:!1,derivePermissionsFromClass:!1,icon:"glyphicon glyphicon-globe",iconFactory:null,policy:"default",leaf:!c,isLeaf:!c,getChildren:f}},e=function(a){var b,c,d=JSON.parse(a).$collection,e=[];for(b=0;b<d.length;++b)c=f(d[b]),e.push(c);return e},g=a(c+"/nodes",{nodeId:"@id",domain:d},{get:{method:"GET",params:{deduplicate:!0},url:c+"/"+d+".worldstates/:nodeId?omitNullValues=false&deduplicate=true",transformResponse:function(a){var b;return a?(b=JSON.parse(a),f(b)):null}},query:{method:"GET",isArray:!0,url:c+"/"+d+".worldstates?limit=100&offset=0&level=1&filter=parentworldstate%3Anull&omitNullValues=false&deduplicate=true",transformResponse:function(a){return e(a)}},children:{method:"GET",isArray:!0,params:{level:2},url:c+"/"+d+".worldstates",transformResponse:function(a){return e(a)},dynamicChildren:{method:"POST",url:"",transformResult:function(a){return e(a)}}},scenarios:{method:"GET",isArray:!0,url:c+"/"+d+".worldstates?level=5&filter=childworldstates:\\[\\]&omitNullValues=false&deduplicate=true",transformResponse:function(a){return e(a)}}}),h={getRequestIdForWorldstate:function(a){return a.id},getRequestIdForNodeKey:function(a){return a.indexOf(".")>-1?a.substring(a.lastIndexOf(".")+1,a.length):a}},g.utils=h,g}]),angular.module("de.cismet.crisma.ICMM.Worldstates",["ngResource"]).factory("de.cismet.crisma.ICMM.Worldstates",["$resource","CRISMA_ICMM_API","CRISMA_DOMAIN",function(a,b,c){"use strict";var d,e,f,g;return d=function(a){if(!a)return null;var b=JSON.parse(a);return b},e=function(a){var b=JSON.parse(a).$collection;return b},f=a(b+"/"+c+".worldstates/:wsId",{wsId:"@id",deduplicate:!1,level:"5",omitNullValues:"false"},{get:{method:"GET",transformResponse:d},query:{method:"GET",isArray:!0,params:{level:"1",omitNullValues:"true"},transformResponse:e}}),g=function(){var a;return a={},a.stripIccData=function(a,b){var c,d,e,f,g,h,i;for(d=[],e=0;e<a.length;++e){for(i=a[e],f=i.iccdata,c=null,g=0;g<f.length&&!c;++g)if(f[g]&&f[g].categories)for(h=0;h<f[g].categories.length&&!c;++h)b&&"Criteria"===f[g].categories[h].key?c=f[g]:b||"Indicators"!==f[g].categories[h].key||(c=f[g]);if(!c)throw"worldstate without proper icc data:"+i;d.push({name:i.name,data:JSON.parse(c.actualaccessinfo)})}return d},a},f.utils=g(),f}]),angular.module("de.cismet.crisma.ICMM.services",["ngResource"]).factory("de.cismet.crisma.ICMM.services.icmm",["$q","$resource",function(a,b){"use strict";var c,d,e;return c=function(c,e,f,g,h,i){var j,k,l,m,n;return l=a.defer(),m=a.defer(),n=a.defer(),h?l.resolve(h):(j=b(c+"/CRISMA.categories",{limit:"1",filter:"key:icc_data"},{query:{method:"GET",isArray:!0,transformResponse:function(a){var b,c,d;for(b=JSON.parse(a).$collection,c=[],d=0;d<b.length;++d)c.push(b[d]);return c}}}),j.query().$promise.then(function(a){1===a.length?l.resolve(a[0].$ref.substr(a[0].$ref.lastIndexOf("/")+1)):l.reject("cannot find id of ICC dataitem default category")})),i?m.resolve(i):(k=b(c+"/CRISMA.datadescriptors",{limit:"1",filter:"name:ICC Data Vector descriptor"},{query:{method:"GET",isArray:!0,transformResponse:function(a){var b,c,d;for(b=JSON.parse(a).$collection,c=[],d=0;d<b.length;++d)c.push(b[d]);return c}}}),k.query().$promise.then(function(a){1===a.length?m.resolve(a[0].$ref.substr(a[0].$ref.lastIndexOf("/")+1)):m.reject("cannot find id of ICC dataitem default datadescriptor")})),a.all([d(c,"/CRISMA.dataitems"),l.promise,m.promise]).then(function(a){n.resolve({$self:"/CRISMA.dataitems/"+a[0],name:e,description:f,lastmodified:(new Date).toISOString(),datadescriptor:{$ref:"/CRISMA.datadescriptors/"+a[2]},actualaccessinfocontenttype:"application/json",actualaccessinfo:JSON.stringify(g),categories:[{$ref:"/CRISMA.categories/"+a[1]}]})},function(a){n.reject(a)}),n.promise},d=function(c,d){var e,f,g;return e=a.defer(),f=b(c+d,{limit:"999999999"},{query:{method:"GET",isArray:!0,transformResponse:function(a){var b,c,d;for(b=JSON.parse(a).$collection,c=[],d=0;d<b.length;++d)c.push(b[d]);return c}}}),g=f.query(),g.$promise.then(function(a){var b,c,d;for(d=0,b=0;b<a.length;++b)c=parseInt(a[b].$ref.substr(a[b].$ref.lastIndexOf("/")+1),10),c>d&&(d=c);e.resolve(d+1)}),e.promise},e=function(a){var b,c,d,e;if(c=a.iccdata,!c)throw new Error("Worldstate has no iccData field. Can not check the indicator format.");if("[object Object]"===Object.prototype.toString.call(c))c.categories?(e=!1,c.categories.forEach(function(a){a&&a.key&&"Indicators"===a.key&&(e=!0)}),e||c.categories.push({key:"Indicators"})):c.categories=[{key:"Indicators"}],a.iccdata=[a.iccdata];else if("[object Array]"===Object.prototype.toString.call(c)){if(c.length<=0)throw new Error("Worldstate icc data is an empty array.");c.forEach(function(a){if(a&&a.categories)for(b=0;b<a.categories.length;b++)"Indicators"===a.categories[b].key&&(d=a)}),d||(a.iccdata[0].categories=[{key:"Indicators",classification:{$self:"/CRISMA.classifications/2",id:2,key:"ICC_DATA"}}])}return a},{createICCDataItem:c,getNextId:d,convertToCorrectIccDataFormat:e}}]);